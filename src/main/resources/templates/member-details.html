<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sojrel Sacco Ltd</title>
    <link th:fragment="icon" rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link href="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-1.13.6/datatables.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="styles.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.cdnfonts.com/css/poppins" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mina:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-1.13.6/datatables.min.js"></script>
<!--    <style>-->
<!--            /* Reset default margin and padding-->
<!--          * {-->
<!--              margin: 0;-->
<!--              padding: 0;-->
<!--              box-sizing: border-box;-->
<!--          }-->

<!--          /* Define minimum height for the whole layout */-->
<!--          body {-->
<!--              min-height: 100%;-->
<!--              display: flex;-->
<!--              flex-direction: column;-->
<!--          }-->

<!--          /* Style the navigation bar */-->
<!--          .navbar {-->
<!--              height: 80px;-->
<!--              background-color: #333;-->
<!--              color: white;-->
<!--              display: flex;-->
<!--              align-items: center;-->
<!--              justify-content: center;-->
<!--          }-->

<!--          Create a container to hold sidebar and main content */-->

<!--    </style>-->
</head>
<body>
    <div id="navbar-container" th:insert="~{base :: navbar}"></div>
    <div class="row body-section">
        <div th:insert="~{base :: sidebar}" class="sidebar-container col-lg-2 p-0" id="sidebar-container"></div>
        <div class="my-section col-lg-10">
            <span id="results"></span>
            <span class="d-flex justify-content-center mt-3 text-success fs-3 fw-bold">Member Details</span>
            <hr class="border-2 border-success">
            <table class="table" id="details-table">
                <tbody>
                    <tr>
                        <th scope="row row-scoped" style="width:40%">Member ID</th>
                        <td th:text="${member.id}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Name:</th>
                        <td th:text="${member.firstName+' '+member.midName+' '+member.lastName}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Registration Date:</th>
                        <td th:text="${#temporals.format(member.regDate,'dd MMM yyyy')}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">ID No:</th>
                        <td th:text="${member.idNo}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Date of Birth:</th>
                        <td th:text="${#dates.format(member.dob,'dd MMM yyyy')}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Email:</th>
                        <td th:text="${member.email}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Phone Number:</th>
                        <td th:text="${member.phone}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">KRA Pin:</th>
                        <td th:text="${member.kraPin}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Address:</th>
                        <td th:text="${member.address}"></td>
                    </tr>
                    <tr>
                        <th scope="row row-scoped">Residence:</th>
                        <td th:text="${member.residence}"></td>
                    </tr>
                    <tr th:if="${idFrontPath} !=null">
                        <th scope="row row-scoped">Id Front Image:</th>
                        <td>
                            <a th:href="${idFrontPath}" download>
                                <img th:src="${idFrontPath}" alt="front id image" width="160" height="80">
                            </a>
                        </td>
                    </tr>
                    <tr th:if="${idBackPath}!=null">
                        <th scope="row row-scoped">ID Back Image:</th>
                        <td>
                            <a th:href="${idBackPath}" download>
                                <img th:src="${idBackPath}" alt="back id image" width="160" height="80">
                            </a>
                        </td>
                    </tr>
                    <tr th:if="${kraCertPath} != null">
                        <th scope="row row-scoped">Kra Certificate:</th>
                        <td>
                            <i class="fa fa-paperclip mx-1" aria-hidden="true"></i><a class="text-decoration-none text-dark" th:href="${kraCertPath}" download th:text="${kraCertName}">

                            </a>
                        </td>
                    </tr>
                    <tr th:if="${passportPath} != null">
                        <th scope="row row-scoped">Passport:</th>
                        <td>
                            <a th:href="${passportPath}" download>
                                <img th:src="${passportPath}" alt="passport image" width="120" height="160">
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>

            <span class="d-flex justify-content-center text-success fw-bold">Contributions</span>
            <div class="totals">
                <div class="contribution-box">
                    <span>Total</span>
                    <span th:text="${total} != null ? ${'KES '+ total}: 'KES 0.00'"></span>
                </div>
                <div class="contribution-box">
                    <span>Shares</span>
                    <span th:text="${shares}!=null ? ${'KES '+shares}: 'KES 0.00'"></span>

                </div>
                <div class="contribution-box">
                    <span>Savings</span>
                    <span th:text="${savings}!=null?${'KES '+savings}: 'KES 0.00'"></span>
                </div>
                <div class="contribution-btn d-flex align-items-center">
                    <button class="contrib-btn btn" data-bs-toggle="modal" data-bs-target="#contribModal">Add Contribution</button>
                </div>
            </div>
            <div class="modal fade" id="contribModal" tabindex="-1" aria-labelledby="contribModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h6 class="modal-title" id="contribModalLabel">Add Contribution</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="contribution-form" method="post">
                                <div class="mb-3">
                                    <input hidden id="id" th:value="${member.id}">
                                    <div class="mb-3">
                                        <label for="type" class="form-label">Contribution Type:</label>
                                        <select class="selection form-control col-2 mb-4" id="type">
                                            <option align="center" value="">----Select Contribution Type----</option>
                                            <option value="SAVINGS">SAVINGS</option>
                                            <option value="SHARES">SHARES</option>
                                        </select>
                                    </div>
                                    <span id="type-msg"></span>
                                    <div class="mb-3">
                                        <label for="amount" class="form-label">Enter Amount:</label>
                                        <input type="number" id="amount" class="form-control">
                                    </div>
                                    <span id="amt-msg"></span>
                                </div>
                                <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
                                <button type="submit" id="submitBtn" class="btn">Save</button>
                            </form>
                        </div>
                        <div class="modal-footer">
                        </div>
                    </div>
                </div>
            </div>
            <hr class="border-2 border-success">
            <div class="container detail-table-area mt-4">
                <div class="table-responsive table-responsive-sm">
                    <table class="table" id="member-contributions-table" style="width:100%;">
                        <thead>
                            <th>ID.</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                        </thead>
                        <tbody>
                        <tr th:each="contribution: ${member.contributions}">
                            <td data-label="ID:" th:text="${contribution.id}"></td>
                            <td data-label="Date:" th:text="${#temporals.format(contribution.contributionDate,'dd MMM yyyy')}"></td>
                            <td data-label="Type:" th:text="${contribution.contributionType}"></td>
                            <td data-label="Amount:" th:text="${contribution.amount != null? 'Ksh '+ contribution.amount: 'Ksh 0'}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <hr class="border-2 border-success">
            <span class="d-flex justify-content-center text-success fw-bold">Loans</span>
            <hr class="border-2 border-success">
            <div class="container detail-table-area mt-4">
                <div class="table-responsive table-responsive-sm">
                    <table class="table" id="member-loans-table" style="width:100%;">
                        <thead>
                        <th>Loan ID.</th>
                        <th>Type</th>
                        <th>Principal</th>
                        <th>Instalments</th>
                        <th class="hide-md">Interest</th>
                        <th>Status</th>
                        </thead>
                        <tbody>
                        <tr th:each="loan: ${member.loansTaken}">
                            <td data-label="Loan ID:" th:text="${loan.id}"></td>
                            <td data-label="Type:" th:text="${loan.loanType}"></td>
                            <td data-label="Principal:" th:text="${'Ksh '+loan.principal}"></td>
                            <td data-label="Instalments:" th:text="${loan.instalments}"></td>
                            <td data-label="Interest:" th:text="${loan.interest}" class="hide-md"></td>
                            <td data-label="Status:" th:text="${loan.loanStatus}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <hr class="border-2 border-success">
            <div class="container guarantee-container">
                <div class="rounded guaranteed-sub-container text-light">
                    <span class="d-flex justify-content-center fw-bold">Total Guaranteed</span>
                    <span class="d-flex justify-content-center fw-bold" th:text="'Ksh '+ ${guaranteed}"></span>
                </div>

                <div class="rounded guaranteed-sub-container text-light">
                    <span class="d-flex justify-content-center fw-bold">Guarantee Limit</span>
                    <span class="d-flex justify-content-center fw-bold" th:text="'Ksh '+ ${guaranteeLimit}"></span>
                </div>
            </div>



            <span class="d-flex justify-content-center text-success fw-bold">Loans Guaranteed</span>
            <hr class="border-2 border-success">
            <div class="container detail-table-area mt-4">
                <div class="table-responsive table-responsive-sm">
                    <table class="table" id="member-guarantee-table" style="width:100%;">
                        <thead>
                            <th>Loan ID.</th>
                            <th>Type</th>
                            <th>Principal</th>
                            <th>Instalments</th>
                            <th class="hide-md">Interest</th>
                            <th>Status</th>
                        </thead>
                        <tbody>
                        <tr th:each="guarantee: ${member.loansGuaranteed}">
                            <td data-label="Loan ID:" th:text="${guarantee.id}"></td>
                            <td data-label="Type:" th:text="${guarantee.loanType}"></td>
                            <td data-label="Principal:" th:text="${'Ksh '+guarantee.principal}"></td>
                            <td data-label="Instalments:" th:text="${guarantee.instalments}"></td>
                            <td data-label="Interest:" th:text="${guarantee.interest}" class="hide-md"></td>
                            <td data-label="Status:" th:text="${guarantee.loanStatus}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <hr>
        </div>
    </div>
</div>
    <div th:insert="~{base :: footer}">  </div>
    <script src="main.js" type="text/javascript"></script>
    <script src="jquery.js" type="text/javascript"></script>


    <script>
        $(document).ready(function(){
            new DataTable("#member-contributions-table", {
                processing:true,
                pagingType:'simple_numbers'
            });
        });

        $(document).ready(function(){
            new DataTable("#member-loans-table", {
                processing:true,
                pagingType:'simple_numbers'
            });
        });

        $(document).ready(function(){
            new DataTable("#member-guarantee-table", {
                processing:true,
                pagingType:'simple_numbers'
            });
        });






        $(document).ready(function (){
            $("#contrib-form").submit(function(event){
                event.preventDefault();
                if($("#id").val()==""){
                    alert("Enter ID");
                }
                else if($("#type").val()==""){
                    alert("Choose type");
                }
                else if($("#amount").val()==""){
                    alert ("Enter amount");
                }
                else{
                    var originalButtonText = $("#submitBtn").html();
                    $("#submitBtn").html('<div class="spinner-border" role="status" id="spinner">' +
                                  '<span class="visually-hidden"></span>' +
                                  '</div> Please wait...');

                    let formData = {
                        memberId: $("#id").val(),
                        contributionType:$("#type").val(),
                        amount:$("#amount").val()
                    }
                    $.ajax({
                        type : "POST",
                        contentType : "application/json",
                        url : "/save-contributions",
                        data : JSON.stringify(formData),
                        dataType : 'json',
                        success: function(result){
                            if(result.status == "success"){
                                $("#submitBtn").html(originalButtonText);
                                $("#results").html('<div style="background-color:#7FA7B0; color:white;padding:20px 0px; text-align:center; width:100%;"><p>Contribution added successfully</p></div>');
                                $("#results").fadeToggle(3000);
                                $("#contrib-form")[0].reset();
                            }
                            else{
                                $("#submitBtn").html(originalButtonText);
                                $("#results").html('<div style="background-color:#7FA7B0; color:white;padding:20px 0px; text-align:center; width:100%;">Failed</p></div>');
                                $("#results").fadeToggle(3000);
                                $("#contrib-form")[0].reset();
                            }


                        },
                        error: function (xhr, status, error) {
                            console.log(error)
                            console.log(status)
                            $("#results").html('<div style="background-color:#7FA7B0; color:white;padding:20px 0px; text-align:center; width:100%;"><p>Error</p></div>');
                            $("#results").fadeToggle(3000);
                            $("#sub-form")[0].reset();
                            $("#submitBtn").html(originalButtonText);
                            $("#contrib-form")[0].reset();
                            // Log the error response for inspection
                            console.log(xhr.responseText);
                            //close activity indicator here
                        }

                    });
                }
            });
        });
    </script>
</body>
</html>

